<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - ä¸è§’è‰²å¯¹è¯</title>

    <!-- ç«‹å³åº”ç”¨èƒŒæ™¯ï¼Œé¿å…é—ªçƒ -->
    <script>
        (function() {
            var savedBg = localStorage.getItem('selectedBackground') || 'IMG_E5419.jpeg';
            var bgUrl = savedBg.indexOf('http') === 0 ? savedBg : '../image/fll/system_image/' + savedBg;
            document.write('<style>body{background-image:url("' + bgUrl + '")!important;background-size:cover!important;background-position:center!important;background-attachment:fixed!important;}</style>');
        })();
    </script>

    <link rel="stylesheet" href="../css/nav.css">
    <link rel="stylesheet" href="../css/body.css">
    <link rel="stylesheet" href="../css/blog.css">
    <link rel="stylesheet" href="../css/homestyle.css">
    <link rel="stylesheet" href="../css/music.css">

    <!-- ç™¾åº¦ç»Ÿè®¡ -->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c37b574919c030aba383a1cdcccdc6ef";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
</head>
<body>
    <nav>
        <div class="navtitle"><strong>PHROLOVA</strong></div>
        <button class="bg-selector-btn" onclick="openImageSelector()" title="é€‰æ‹©èƒŒæ™¯">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21 15 16 10 5 21"/>
            </svg>
        </button>
        <button class="music-btn" onclick="toggleMusicPlayer()" title="éŸ³ä¹æ’­æ”¾å™¨">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18V5l12-2v13"></path>
                <circle cx="6" cy="18" r="3"></circle>
                <circle cx="18" cy="16" r="3"></circle>
            </svg>
        </button>
        <a href="home.html">HOME</a>
        <a href="information.html">VIDEO</a>
        <a href="chat.html">CHAT</a>
        <a href="album.html">ALBUM</a>
        <a href="board.html">BOARD</a>
        <div class="navanim blog"></div>
        <div class="none"></div>
    </nav>

    <div class="chat-container">
        <!-- èŠå¤©å¤´éƒ¨ -->
        <div class="chat-header">
            <div class="chat-avatar">
                <img src="../image/homepic1.png" alt="è§’è‰²å¤´åƒ">
            </div>
            <div class="chat-info">
                <h2>WZY åŠ©æ‰‹</h2>
                <p class="status">åœ¨çº¿</p>
            </div>
            <button id="clearBtn" class="clear-btn">ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯</button>
        </div>

        <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <p>ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ WZY åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ</p>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="chat-input-container">
            <textarea
                id="messageInput"
                class="chat-input"
                placeholder="è¾“å…¥æ¶ˆæ¯..."
                rows="1"
            ></textarea>
            <button id="sendBtn" class="send-btn">
                <span>å‘é€</span>
                <span class="send-icon">ğŸ“¤</span>
            </button>
        </div>
    </div>

    <!-- å›¾ç‰‡é€‰æ‹©å¼¹çª— -->
    <div id="imageSelector" class="image-selector">
        <div class="selector-content">
            <h2 class="selector-title">é€‰æ‹©ä½ å–œæ¬¢çš„èƒŒæ™¯</h2>
            <div class="image-grid" id="imageGrid"></div>
            <button class="close-btn" onclick="closeImageSelector()">å…³é—­</button>
        </div>
    </div>

    <!-- éŸ³ä¹æ’­æ”¾å™¨ -->
    <div id="musicPlayer" class="music-player">
        <div class="music-header">
            <h3>ğŸµ éŸ³ä¹æ’­æ”¾å™¨</h3>
            <button class="close-music-btn" onclick="toggleMusicPlayer()">Ã—</button>
        </div>
        <div class="music-info">
            <div class="music-cover">
                <img id="musicCover" src="../image/homepic1.png" alt="å°é¢">
            </div>
            <div class="music-details">
                <div class="music-title" id="musicTitle">æœªé€‰æ‹©éŸ³ä¹</div>
                <div class="music-artist" id="musicArtist">-</div>
            </div>
        </div>
        <div class="music-progress">
            <span class="time-current" id="currentTime">0:00</span>
            <input type="range" class="progress-bar" id="progressBar" min="0" max="100" value="0">
            <span class="time-total" id="totalTime">0:00</span>
        </div>
        <div class="music-controls">
            <button class="control-btn" id="shuffleBtn" onclick="toggleShuffle()" title="éšæœºæ’­æ”¾">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="16 3 21 3 21 8"></polyline>
                    <line x1="4" y1="20" x2="21" y2="3"></line>
                    <polyline points="21 16 21 21 16 21"></polyline>
                    <line x1="15" y1="15" x2="21" y2="21"></line>
                    <line x1="4" y1="4" x2="9" y2="9"></line>
                </svg>
            </button>
            <button class="control-btn" onclick="previousTrack()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 6h2v12H6zM10 6l8.5 6l-8.5 6z"/>
                </svg>
            </button>
            <button class="control-btn play-btn" id="playBtn" onclick="togglePlay()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                </svg>
            </button>
            <button class="control-btn" onclick="nextTrack()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M5.5 6l8.5 6l-8.5 6V6zM16 6h2v12h-2z"/>
                </svg>
            </button>
            <button class="control-btn" id="loopBtn" onclick="toggleLoop()" title="å•æ›²å¾ªç¯">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 1l4 4-4 4"></path>
                    <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                    <path d="M7 23l-4-4 4-4"></path>
                    <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                    <text x="12" y="16" font-size="10" fill="currentColor" text-anchor="middle" font-weight="bold">1</text>
                </svg>
            </button>
        </div>
        <div class="music-playlist">
            <h4>æ’­æ”¾åˆ—è¡¨</h4>
            <div id="playlistContainer" class="playlist-items">
                <div class="playlist-item" onclick="loadTrack(0)">
                    <span>1. ç¤ºä¾‹æ­Œæ›² 1</span>
                </div>
            </div>
        </div>
    </div>

    <audio id="audioPlayer" preload="metadata"></audio>

    <script>
        // åº”ç”¨ä¿å­˜çš„èƒŒæ™¯
        window.addEventListener('DOMContentLoaded', function() {
            const savedBg = localStorage.getItem('selectedBackground') || 'IMG_E5419.jpeg';
            // å¦‚æœæ˜¯å®Œæ•´ URLï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™ä½¿ç”¨æœ¬åœ°è·¯å¾„
            const bgUrl = savedBg.startsWith('http') ? savedBg : `../image/fll/system_image/${savedBg}`;
            document.body.style.backgroundImage = `url('${bgUrl}')`;
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundPosition = 'center';
            document.body.style.backgroundAttachment = 'fixed';

            // åˆå§‹åŒ–èƒŒæ™¯é€‰æ‹©å™¨
            initBackgroundSelector();

            // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
            initMusicPlayer();
        });

        // ====== éŸ³ä¹æ’­æ”¾å™¨åŠŸèƒ½ ======
        const audioPlayer = document.getElementById('audioPlayer');
        let currentTrackIndex = 0;
        let isLooping = false;
        let isShuffling = false;

        // éŸ³ä¹åˆ—è¡¨
        const playlist = [
            { title: 'é…£æ¢¦äºå½¼å²¸æ·±çº¢', artist: 'fll', src: '../music/fll_é…£æ¢¦äºå½¼å²¸æ·±çº¢.ogg', cover: '../image/homepic1.png' },
            { title: 'é‚£é¢—æ˜Ÿæ¢¦è§çš„æ˜¥æ—¥', artist: 'imiss', src: '../music/imiss_é‚£é¢—æ˜Ÿæ¢¦è§çš„æ˜¥æ—¥.ogg', cover: '../image/homepic1.png' },
            { title: 'è¿œèˆªæ˜Ÿçš„å‘Šåˆ«', artist: 'imiss', src: '../music/imiss_è¿œèˆªæ˜Ÿçš„å‘Šåˆ«.ogg', cover: '../image/homepic1.png' }
        ];

        function initMusicPlayer() {
            // æ¸²æŸ“æ’­æ”¾åˆ—è¡¨
            renderPlaylist();

            // ç»‘å®šè¿›åº¦æ¡äº‹ä»¶
            const progressBar = document.getElementById('progressBar');
            progressBar.addEventListener('input', function() {
                const seekTime = (audioPlayer.duration / 100) * this.value;
                audioPlayer.currentTime = seekTime;
            });

            // ç›‘å¬éŸ³é¢‘æ—¶é—´æ›´æ–°
            audioPlayer.addEventListener('timeupdate', updateProgress);

            // ç›‘å¬éŸ³é¢‘ç»“æŸ
            audioPlayer.addEventListener('ended', function() {
                if (isLooping) {
                    audioPlayer.currentTime = 0;
                    audioPlayer.play();
                } else {
                    nextTrack();
                }
            });

            // ç›‘å¬éŸ³é¢‘åŠ è½½å®Œæˆ
            audioPlayer.addEventListener('loadedmetadata', function() {
                document.getElementById('totalTime').textContent = formatTime(audioPlayer.duration);
            });
        }

        function renderPlaylist() {
            const container = document.getElementById('playlistContainer');
            container.innerHTML = '';

            playlist.forEach((track, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                if (index === currentTrackIndex) {
                    item.classList.add('active');
                }
                item.innerHTML = `<span>${index + 1}. ${track.title} - ${track.artist}</span>`;
                item.onclick = () => loadTrack(index);
                container.appendChild(item);
            });
        }

        function loadTrack(index) {
            if (index < 0 || index >= playlist.length) return;

            currentTrackIndex = index;
            const track = playlist[index];

            audioPlayer.src = track.src;
            document.getElementById('musicTitle').textContent = track.title;
            document.getElementById('musicArtist').textContent = track.artist;
            document.getElementById('musicCover').src = track.cover;

            renderPlaylist();

            // è‡ªåŠ¨æ’­æ”¾
            audioPlayer.play().catch(err => {
                console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢:', err);
            });

            updatePlayButton(true);
        }

        function togglePlay() {
            if (audioPlayer.paused) {
                if (!audioPlayer.src) {
                    loadTrack(0);
                } else {
                    audioPlayer.play();
                }
                updatePlayButton(true);
            } else {
                audioPlayer.pause();
                updatePlayButton(false);
            }
        }

        function updatePlayButton(isPlaying) {
            const playBtn = document.getElementById('playBtn');
            if (isPlaying) {
                playBtn.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 4h4v16H6zM14 4h4v16h-4z"/>
                    </svg>
                `;
            } else {
                playBtn.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                `;
            }
        }

        function previousTrack() {
            currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
            loadTrack(currentTrackIndex);
        }

        function nextTrack() {
            if (isShuffling) {
                // éšæœºé€‰æ‹©ä¸‹ä¸€é¦–ï¼ˆä¸é‡å¤å½“å‰æ­Œæ›²ï¼‰
                let nextIndex;
                do {
                    nextIndex = Math.floor(Math.random() * playlist.length);
                } while (nextIndex === currentTrackIndex && playlist.length > 1);
                currentTrackIndex = nextIndex;
            } else {
                currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
            }
            loadTrack(currentTrackIndex);
        }

        function toggleLoop() {
            isLooping = !isLooping;
            const loopBtn = document.getElementById('loopBtn');
            const shuffleBtn = document.getElementById('shuffleBtn');

            if (isLooping) {
                // å¼€å¯å¾ªç¯ï¼Œå…³é—­éšæœº
                isShuffling = false;
                shuffleBtn.style.color = 'rgba(255, 255, 255, 0.85)';
                shuffleBtn.style.transform = 'scale(1)';
            }

            loopBtn.style.color = isLooping ? '#FF6B9D' : 'rgba(255, 255, 255, 0.85)';
            loopBtn.style.transform = isLooping ? 'scale(1.1)' : 'scale(1)';
        }

        function toggleShuffle() {
            isShuffling = !isShuffling;
            const shuffleBtn = document.getElementById('shuffleBtn');
            const loopBtn = document.getElementById('loopBtn');

            if (isShuffling) {
                // å¼€å¯éšæœºï¼Œå…³é—­å¾ªç¯
                isLooping = false;
                loopBtn.style.color = 'rgba(255, 255, 255, 0.85)';
                loopBtn.style.transform = 'scale(1)';
            }

            shuffleBtn.style.color = isShuffling ? '#FF6B9D' : 'rgba(255, 255, 255, 0.85)';
            shuffleBtn.style.transform = isShuffling ? 'scale(1.1)' : 'scale(1)';
        }

        function updateProgress() {
            const progressBar = document.getElementById('progressBar');
            const currentTime = document.getElementById('currentTime');

            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBar.value = progress || 0;
            currentTime.textContent = formatTime(audioPlayer.currentTime);
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function toggleMusicPlayer() {
            const player = document.getElementById('musicPlayer');
            player.classList.toggle('show');
        }

        // åˆå§‹åŒ–èƒŒæ™¯é€‰æ‹©å™¨
        function initBackgroundSelector() {
            const fallbackImages = [
                'IMG_E5416.JPG', 'IMG_E5417.jpeg', 'IMG_E5419.jpeg',
                'IMG_E5421-upscaled.png', 'IMG_E5423-upscaled.png',
                'IMG_E5424-upscaled.png', 'IMG_E5426-upscaled.png', 'IMG_E5427-upscaled.png',
                'IMG_E5429-upscaled.png', 'IMG_E5430-upscaled.png', 'IMG_E5431-upscaled.png',
                'IMG_E5432-upscaled.png', 'IMG_E5433-upscaled.png', 'IMG_E5434-upscaled.png'
            ];

            const imageGrid = document.getElementById('imageGrid');
            imageGrid.innerHTML = '';

            const savedBg = localStorage.getItem('selectedBackground') || 'IMG_E5419.jpeg';

            fallbackImages.forEach((img, index) => {
                const item = document.createElement('div');
                item.className = 'image-item';

                const imgElement = document.createElement('img');
                imgElement.loading = 'lazy';
                imgElement.src = `../image/fll/system_image/${img}`;
                imgElement.alt = `èƒŒæ™¯${index + 1}`;

                // å¦‚æœæ˜¯å½“å‰é€‰ä¸­çš„èƒŒæ™¯ï¼Œæ·»åŠ  selected ç±»
                if (img === savedBg) {
                    item.classList.add('selected');
                }

                item.appendChild(imgElement);
                item.onclick = () => selectImage(img, item);
                imageGrid.appendChild(item);
            });
        }

        // é€‰æ‹©å›¾ç‰‡
        function selectImage(imageUrl, element) {
            // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.image-item').forEach(item => {
                item.classList.remove('selected');
            });
            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            element.classList.add('selected');
            // æ›´æ”¹èƒŒæ™¯
            applyBackground(imageUrl);
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('selectedBackground', imageUrl);
        }

        // åº”ç”¨èƒŒæ™¯
        function applyBackground(imageUrl) {
            const bgUrl = imageUrl.startsWith('http') ? imageUrl : `../image/fll/system_image/${imageUrl}`;
            document.body.style.setProperty('background-image', `url('${bgUrl}')`, 'important');
            document.body.style.setProperty('background-size', 'cover', 'important');
            document.body.style.setProperty('background-position', 'center', 'important');
            document.body.style.setProperty('background-attachment', 'fixed', 'important');
        }

        // æ‰“å¼€é€‰æ‹©å™¨
        function openImageSelector() {
            document.getElementById('imageSelector').style.display = 'flex';
        }

        // å…³é—­é€‰æ‹©å™¨
        function closeImageSelector() {
            document.getElementById('imageSelector').style.display = 'none';
        }
    </script>

    <script src="../js/chat.js"></script>
</body>
</html>
